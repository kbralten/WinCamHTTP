<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="WinCamHTTP Virtual Camera"
           Manufacturer="WinCamHTTP Project"
           Version="1.0.0.0"
           UpgradeCode="{12345678-1234-1234-1234-123456789012}"
           Scope="perMachine">

  <!-- Major upgrade configuration -->
  <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <!-- Media definition -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Installation directory structure (WiX v4 StandardDirectory) -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="WinCamHTTP" />
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="WinCamHTTP" />
    </StandardDirectory>

    <!-- Feature definition -->
    <Feature Id="ProductFeature" Title="WinCamHTTP Virtual Camera" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ProgramMenuDir" />
    </Feature>

    <!-- Program Menu Directory Component -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ProgramMenuDir" Guid="{87654321-4321-4321-4321-210987654321}">
        <CreateFolder />
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\WinCamHTTP" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
        
        <!-- Setup Application Shortcut -->
  <Shortcut Id="WinCamHTTPSetupShortcut"
                  Name="WinCamHTTP Setup"
                  Description="Configure WinCamHTTP Virtual Camera Settings"
                  Target="[INSTALLFOLDER]WinCamHTTPSetup.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        
        <!-- Main Application Shortcut -->
  <Shortcut Id="WinCamHTTPShortcut"
                  Name="WinCamHTTP"
                  Description="WinCamHTTP Virtual Camera Tray Application"
                  Target="[INSTALLFOLDER]WinCamHTTP.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        
        <!-- Uninstall Shortcut -->
        <Shortcut Id="UninstallProduct"
                  Name="Uninstall WinCamHTTP"
                  Description="Uninstalls WinCamHTTP Virtual Camera"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />
      </Component>
    </DirectoryRef>

    <!-- Components Group -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      
      <!-- Main Virtual Camera DLL -->
      <Component Id="VirtualCameraDLL" Guid="{11111111-1111-1111-1111-111111111111}">
        <File Id="WinCamHTTPSourceDLL" 
              Source="..\x64\Release\WinCamHTTPSource.dll" 
              KeyPath="yes">
          <!-- COM Registration for the Virtual Camera DLL -->
          <Class Id="{12345678-ABCD-EFAB-CDEF-123456789ABC}"
                 Context="InprocServer32"
                 Description="WinCamHTTP Source"
                 ThreadingModel="both" />
        </File>
      </Component>
      
      <!-- Setup Application -->
  <Component Id="SetupApplication" Guid="{22222222-2222-2222-2222-222222222222}">
        <File Id="WinCamHTTPSetupEXE" 
              Source="..\x64\Release\WinCamHTTPSetup.exe" 
              KeyPath="yes" />
      </Component>
      
      <!-- Main Tray Application -->
  <Component Id="MainApplication" Guid="{33333333-3333-3333-3333-333333333333}">
        <File Id="WinCamHTTPEXE" 
              Source="..\x64\Release\WinCamHTTP.exe" 
              KeyPath="yes" />
      </Component>
      
      <!-- Debug Symbols (Optional) -->
  <Component Id="DebugSymbols" Guid="{44444444-4444-4444-4444-444444444444}">
        <File Id="WinCamHTTPSourcePDB" 
              Source="..\x64\Release\WinCamHTTPSource.pdb" 
              KeyPath="yes" />
        <File Id="WinCamHTTPSetupPDB" 
              Source="..\x64\Release\WinCamHTTPSetup.pdb" />
        <File Id="WinCamHTTPPDB" 
              Source="..\x64\Release\WinCamHTTP.pdb" />
      </Component>
      
      <!-- Registry Configuration -->
  <Component Id="RegistryConfig" Guid="{55555555-5555-5555-5555-555555555555}">
        <RegistryKey Root="HKLM" Key="SOFTWARE\WinCamHTTP">
          <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" KeyPath="yes" />
          <RegistryValue Name="Version" Type="string" Value="1.0.0.0" />
        </RegistryKey>
      </Component>
      
    </ComponentGroup>

    <!-- Custom Actions for COM Registration are no longer needed -->

    <!-- The InstallExecuteSequence no longer needs custom actions for COM registration -->
    <InstallExecuteSequence>
    </InstallExecuteSequence>

    <!-- UI Configuration -->
    <!-- No custom UI in WiX v4 minimal configuration; end-user can launch apps from Start Menu -->
  </Package>
</Wix>